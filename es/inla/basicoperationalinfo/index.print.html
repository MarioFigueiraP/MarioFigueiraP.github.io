<!DOCTYPE html>
<html lang="es" dir="ltr">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="description" content="Lista de operaciones básicas que podemos realizar en la librería R-INLA.">
    <meta name="author" content="Mario Figueira">
    <title>Operaciones Básicas :: Documentación</title>
    <link href="https://MarioFigueiraP.github.io/es/inla/basicoperationalinfo/index.html" rel="canonical" type="text/html" title="Operaciones Básicas :: Documentación">
    <link href="../../../es/inla/basicoperationalinfo/index.xml" rel="alternate" type="application/rss+xml" title="Operaciones Básicas :: Documentación">
    <!-- https://github.com/filamentgroup/loadCSS/blob/master/README.md#how-to-use -->
    <link href="../../../css/fontawesome-all.min.css" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../css/fontawesome-all.min.css" rel="stylesheet"></noscript>
    <link href="../../../css/featherlight.min.css" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../css/featherlight.min.css" rel="stylesheet"></noscript>
    <link href="../../../css/auto-complete.css" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../css/auto-complete.css" rel="stylesheet"></noscript>
    <link href="../../../css/perfect-scrollbar.min.css" rel="stylesheet">
    <link href="../../../css/nucleus.css" rel="stylesheet">
    <link href="../../../css/fonts.css" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="../../../css/fonts.css" rel="stylesheet"></noscript>
    <link href="../../../css/theme.css" rel="stylesheet">
    <link href="../../../css/theme-learn.css" rel="stylesheet" id="variant-style">
    <link href="../../../css/ie.css" rel="stylesheet">
    <link href="../../../css/variant.css" rel="stylesheet">
    <link href="../../../css/print.css" rel="stylesheet" media="print">
    <link href="../../../css/format-print.css" rel="stylesheet">
    <script src="../../../js/url.js"></script>
    <script src="../../../js/variant.js"></script>
    <script>
      // hack to let hugo tell us how to get to the root when using relativeURLs, it needs to be called *url= for it to do its magic:
      // https://github.com/gohugoio/hugo/blob/145b3fcce35fbac25c7033c91c1b7ae6d1179da8/transform/urlreplacers/absurlreplacer.go#L72
      window.index_js_url="../../../es/index.search.js";
      var root_url="../../../";
      var baseUri=root_url.replace(/\/$/, '');
      // translations
      window.T_Copy_to_clipboard = 'Copiar en el portapapeles';
      window.T_Copied_to_clipboard = '¡Copiado al portapapeles!';
      window.T_Copy_link_to_clipboard = 'Copiar enlace al portapapeles';
      window.T_Link_copied_to_clipboard = '¡Enlace copiado al portapapeles!';
      window.T_No_results_found = 'No se han encontrado resultados para \u0022{0}\u0022';
      window.T_N_results_found = '{1} resultados encontrados para \u0022{0}\u0022';
      // some further base stuff
      var baseUriFull='https:\/\/MarioFigueiraP.github.io/';
      window.variants && variants.init( [ 'learn', 'relearn-light', 'relearn-dark', 'neon', 'blue', 'green', 'red' ] );
    </script>
    <script src="../../../js/jquery.min.js" defer></script>
  </head>
  <body class="mobile-support print" data-url="../../../es/inla/basicoperationalinfo/index.html">
    <div id="body" class="default-animation">
      <div id="sidebar-overlay"></div>
      <div id="toc-overlay"></div>
      <nav id="topbar" class="highlightable" dir="ltr">
        <div>
          <div id="breadcrumbs">
            <span id="sidebar-toggle-span">
              <a href="#" id="sidebar-toggle" title='Menú (CTRL+ALT+n)'><i class="fas fa-bars fa-fw"></i></a>
            </span>
            <ol class="links" itemscope itemtype="http://schema.org/BreadcrumbList">
              <li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><a itemprop="item" href="../../../es/index.html"><span itemprop="name">Inicio</span></a><meta itemprop="position" content="1"> > </li>
              <li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><a itemprop="item" href="../../../es/inla/index.html"><span itemprop="name">INLA</span></a><meta itemprop="position" content="2"> > </li>
              <li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement"><span itemprop="name">Operaciones Básicas</span><meta itemprop="position" content="3"></li>
            </ol>
          </div>
        </div>
      </nav>
      <main id="body-inner" class="highlightable default" tabindex="-1">
        <div class="flex-block-wrapper">
          <div id="head-tags">
          </div>
          <article class="default">
<h1 id="operaciones-b%C3%A1sicas">Operaciones Básicas</h1>

<p>En este apartado expondremos distintas funciones y operaciones básicas, que son fundamentales para la modelización con INLA.</p>

<ul class="children children-li children-sort-weight">
	
<li><a href="../../../es/inla/basicoperationalinfo/linearmodels/index.html">Modelos Lineales Simples</a><p>Ejemplos simples de modelos lineales y evaluación de la salida de la función ``inla(...)``.</p></li>
<li><a href="../../../es/inla/basicoperationalinfo/stacks/index.html">Stacks</a><p>Breve introducción y ejemplificación de la organización de información en Stacks.</p></li>
<li><a href="../../../es/inla/basicoperationalinfo/meshes/index.html">Conformación de Mallas</a><p>Breve introducción a la conformación de mallas.</p></li>
<li><a href="../../../es/inla/basicoperationalinfo/advanced_features/index.html">Características Avanzadas</a><p>Introducción a características avanzadas de INLA y sus usos.</p></li>
</ul>

            <footer class="footline">
            </footer>
          </article>

          <section>
            <h1 class="a11y-only">Subsecciones de Operaciones Básicas</h1>
          <article class="default">
<h1 id="modelos-lineales-simples">Modelos Lineales Simples</h1>


<div class="box notices cstyle info">
    <div class="box-label"><i class="fa-fw fas fa-info"></i> Información de versiones</div>
    <div class="box-content">
<p>En este rótulo inicial exponemos una lista con las versiones de los programas, sistema operativo y librearías con las que se ha ejecutado el código de la presente sección, lo cual se extrae principalmente mediante la función <code>sessionInfo()</code>.</p>
<ul>
<li>SO (version): Windows 11 Home (22H2).</li>
<li>R: 4.2.3 (2023-03-15 ucrt).</li>
<li>RStudio: 2023.06.2 (Build 561).</li>
<li>Libraries:
<ul>
<li>INLA: INLA_23.04.24</li>
</ul>
</li>
</ul>
    </div>
</div>
<p>En esta sección se expondrán distintos ejemplos de modelos sencillos con datos simulados, para así mostrar cómo operar con <strong>R-INLA</strong>. A lo largo de los ejemplos se comentará el código empleado y se tratará de explicar el funcionamiento de las funciones empleadas relativas al paquete <strong>R-INLA</strong>, junto con las salidas de la función de ajuste <code>inla(...)</code>.</p>
<p>Los ejemplos sobre los que trabajaremos son los siguientes:</p>
<ol>
<li>Modelo Gaussiano con interceptor y efecto lineal.</li>
<li>Modelo Gaussiano con factores.</li>
<li>Modelo Gaussiano con efectos aleatorios.
<ol>
<li>Efectos aleatorios no-estructurados (<em>iid</em>)</li>
<li>Efectos aleatorios estructurados en una dimensión (<em>rw</em>, <em>ar</em> y <em>spde</em>)</li>
<li>Efectos aleatorios estructurados en dos dimensiones (<em>besag</em> y <em>spde</em>)</li>
</ol>
</li>
</ol>
<h2 id="1-modelo-gaussiano-con-un-interceptor-y-un-efecto-lineal">1. Modelo Gaussiano con un interceptor y un efecto lineal</h2>
<p>Un ejemplo de modelo Gaussiano sencillo puede ser aquel cuyo predictor lineal esté determinado por un interceptor y un efecto fijo asociado a una variable continua. Es decir, el modelo formalmente es expresable como</p>

<span class="math align-center">
$$\begin{array}{c}
y_i\sim N(\mu_i,\tau),\\
\mu_i = \eta_i = \beta_0 + \beta_1\cdot x_i,
\end{array}$$
</span>
<p>donde 
<span class="math align-center">$y_i$</span> son las realizaciones de la variable aleatoria respuesta 
<span class="math align-center">$Y:Y\sim N(\boldsymbol\mu,\tau)$</span>, 
<span class="math align-center">$\beta_0$</span> es el interceptor, 
<span class="math align-center">$\beta_1$</span> es el parámetro realativo al efecto de la variable explicativa 
<span class="math align-center">$\mathbf{x}$</span>, y 
<span class="math align-center">$x_i$</span> son los valores de la variable explicativa. El código que podríamos utilizar para simular este modelo es el presentado en el siguiente bloque de código.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">x</span> <span class="o">&lt;-</span> <span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="m">1E2</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="m">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">beta_0</span> <span class="o">&lt;-</span> <span class="m">-2</span>
</span></span><span class="line"><span class="cl"><span class="n">beta_1</span> <span class="o">&lt;-</span> <span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">lin_pred</span> <span class="o">&lt;-</span> <span class="n">beta_0</span> <span class="o">+</span> <span class="n">beta_1</span><span class="o">*</span><span class="n">x</span>
</span></span><span class="line"><span class="cl"><span class="n">y</span> <span class="o">&lt;-</span> <span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="m">1E2</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">lin_pred</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="m">3</span><span class="p">)</span>
</span></span></code></pre></div><p>Antes de organizar la información de los datos podemos especificar la fórmula del modelo,</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">formula_inla</span> <span class="o">&lt;-</span> <span class="n">y</span> <span class="o">~</span> <span class="m">-1</span> <span class="o">+</span> <span class="n">beta_0</span> <span class="o">+</span> <span class="n">beta_1</span>
</span></span></code></pre></div><p>donde <code>y</code> es el nombre de la variable respuesta, el término <code>-1</code> elimina el interceptor que se construye por defecto, mientras que <code>beta_0</code> y <code>beta_1</code> son dos parámetros o variables fijas, a las que en el <code>data.frame</code> o la matriz de proyección <code>A</code> se pasarán los pesos asociados a los mismos. En el caso de un interceptor estos pesos sería un vector de unos, mientras que los pesos de los parámetros relativos a las variables explicativas tendrán por pesos los valores de dichas variables.</p>
<p>En la propia fórmula podemos indicar la distribución previa de los parámetros, en concreto para el caso de los efectos lineales lo haríamos como</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">formula_inla</span> <span class="o">&lt;-</span> <span class="n">y</span> <span class="o">~</span> <span class="m">-1</span> <span class="o">+</span> 
</span></span><span class="line"><span class="cl">    <span class="nf">f</span><span class="p">(</span><span class="n">beta_0</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s">&#34;linear&#34;</span><span class="p">,</span> <span class="n">mean.linear</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">prec.linear</span><span class="o">=</span><span class="m">0.001</span><span class="p">)</span> <span class="o">+</span> 
</span></span><span class="line"><span class="cl">    <span class="nf">f</span><span class="p">(</span><span class="n">beta_1</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s">&#34;linear&#34;</span><span class="p">,</span> <span class="n">mean.linear</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">prec.linear</span><span class="o">=</span><span class="m">0.001</span><span class="p">)</span>
</span></span></code></pre></div><p>La información podemos prepararla mediante la función <code>inla.stack(...)</code> para pasarla a la función de ajuste <code>inla(...)</code>, (véase la <a href="https://mariofigueirap.github.io/es/inla/basicoperationalinfo/stacks/index.html">sección dedicada a los <em>stacks</em></a> para más información).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">inf_stack</span> <span class="o">&lt;-</span>
</span></span><span class="line"><span class="cl">    <span class="nf">inla.stack</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">A</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="m">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">effects</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nf">list</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">beta_0</span><span class="o">=</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="nf">length</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                <span class="n">beta_1</span><span class="o">=</span><span class="n">x</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">tag</span><span class="o">=</span><span class="s">&#34;inf_stack&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span></code></pre></div><p>El ajuste del modelo lo realizamos mediante <code>inla(...)</code>, donde indicamos la fórmula, la distribución de la verosimilitud, los datos necesarios para el modelo (que podemos extraer del <em>stack</em> mediante <code>inla.stack.data(...)</code>), y otros elementos de configuración que podemos especificar.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">inla_model</span> <span class="o">&lt;-</span> 
</span></span><span class="line"><span class="cl">    <span class="nf">inla</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">formula</span><span class="o">=</span><span class="n">formula_inla</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nf">inla.stack.data</span><span class="p">(</span><span class="n">inf_stack</span><span class="p">),</span> <span class="n">family</span><span class="o">=</span><span class="s">&#34;gaussian&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">control.predictor</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">A</span><span class="o">=</span><span class="nf">inla.stack.A</span><span class="p">(</span><span class="n">inf_stack</span><span class="p">),</span> <span class="n">compute</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">control.compute</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">waic</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">cpo</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">dic</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">verbose</span><span class="o">=</span><span class="kc">TRUE</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span></code></pre></div><p>En la función <code>inla(...)</code> hemos especificado la fórmula, la distribución de los datos, la matriz de proyección, y además con <code>control.predictor(compute=TRUE)</code> indicamos que se calculen las distribuciones marginales del predictor lineal (para almacenarlas se necesitaría especificar con un argumento extra <code>return.marginals.predictor=TRUE</code>). Con <code>control.compute(waic=TRUE, cpo=TRUE, dic=TRUE, config=TRUE)</code> indicamos que se calcule el WAIC, CPO, DIC, y que la aproximación GMRF interna se almacene.</p>
<p>La salida de la función, guardada en el objeto <code>inla_model</code> según el código empleado, tendremos ciertos sumarios (<em>summaries</em>) de información sobre el ajuste:</p>
<table>
<thead>
<tr>
<th style="text-align:center">Argumento</th>
<th style="text-align:left">Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">summary.fixed</td>
<td style="text-align:left">Resumen de información de las distribuciones posteriores de los efectos fijos.</td>
</tr>
<tr>
<td style="text-align:center">summary.hyperpar</td>
<td style="text-align:left">Resumen de las distribuciones posteriores de los hiper-parámetros (parámetros asociados a la estructura de los efectos aleatorios y de los hiperparámetros de la verosimilitud).</td>
</tr>
<tr>
<td style="text-align:center">summary.random</td>
<td style="text-align:left">Resumen de las distribuciones posteriores para cada uno de los elementos (nodos) de los efectos aleatorios.</td>
</tr>
<tr>
<td style="text-align:center">summary.linear.predictor</td>
<td style="text-align:left">Resumen de las distribuciones posteriores del predictor lineal y el campo latente. Esto se divide en dos partes, una nombrada bajo la siguiente estructura: <code>fitted.APredictor.n</code>, donde <code>n</code> es un valor numérico relativo a la posición asociada a la observación <code>y_n</code>, y <code>fitted.Predictor.m</code>, donde <code>m</code> es un valor numérico relativo a la posición asociada al elemento <code>x_m</code> del campo Gaussiano latente. Es decir, la primera es tras aplicar la matriz de proyección <code>A</code> sobre las observaciones, mientras que la segunda es la relativa al campo latente en sentido estricto. Esto puede volverse algo más complejo al emplear múltiples <em>stacks</em> y múltiples verosimilitudes.</td>
</tr>
</tbody>
</table>
<p>Otros elementos muy útiles de la salida del modelo son las distribuciones marginales, tanto de los parámetros e hiperparámetros, así como de los efectos aleatorios y el predictor lineal.</p>
<table>
<thead>
<tr>
<th style="text-align:center">Argumento</th>
<th style="text-align:left">Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">marginals.fixed</td>
<td style="text-align:left">Distribuciones posteriores de los efectos fijos.</td>
</tr>
<tr>
<td style="text-align:center">marginals.hyperpar</td>
<td style="text-align:left">Distribuciones posteriores de los hiper-parámetros (parámetros asociados a la estructura de los efectos aleatorios y de los hiperparámetros de la verosimilitud).</td>
</tr>
<tr>
<td style="text-align:center">marginals.random</td>
<td style="text-align:left">Distribuciones posteriores para cada uno de los elementos (nodos) de los efectos aleatorios.</td>
</tr>
<tr>
<td style="text-align:center">marginals.linear.predictor</td>
<td style="text-align:left">Distribuciones posteriores del predictor lineal y el campo latente. Esto se divide en dos partes, una nombrada bajo la siguiente estructura: <code>fitted.APredictor.n</code> y <code>fitted.Predictor.m</code>, al igual que habíamos explicado para el resumen de las mismas.</td>
</tr>
</tbody>
</table>
<p>Finalmente, otros elementos de gran interés en la salida del modelo son los valores del DIC, WAIC, CPO y la verosimilitud marginal (<code>mlik</code>).</p>
<table>
<thead>
<tr>
<th style="text-align:center">Argumento</th>
<th style="text-align:left">Descripción</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">marginals.fixed</td>
<td style="text-align:left">Distribuciones posteriores de los efectos fijos.</td>
</tr>
<tr>
<td style="text-align:center">marginals.hyperpar</td>
<td style="text-align:left">Distribuciones posteriores de los hiper-parámetros (parámetros asociados a la estructura de los efectos aleatorios y de los hiperparámetros de la verosimilitud).</td>
</tr>
<tr>
<td style="text-align:center">marginals.random</td>
<td style="text-align:left">Distribuciones posteriores para cada uno de los elementos (nodos) de los efectos aleatorios.</td>
</tr>
<tr>
<td style="text-align:center">mlik</td>
<td style="text-align:left">Verosimilitud marginal para la distintas verosimilitudes.</td>
</tr>
</tbody>
</table>
<h2 id="2-modelo-gaussiano-con-factores">2. Modelo Gaussiano con factores</h2>
<p>En este caso vamos a exponer como se pueden tratar de analizar datos con variables explicativas que son factores con INLA. El modelo del que simularemos los datos es el siguiente</p>

<span class="math align-center">
$$\begin{array}{c}
y_i\sim N(\mu_i,\tau),\\
\mu_i = \eta_i = \beta_0 + \sum_{f=1}^{F}\beta_{f} \cdot x_{if},
\end{array}$$
</span>
<p>donde 
<span class="math align-center">$\beta_0$</span> es el interceptor, 
<span class="math align-center">$\beta_f$</span> es el parámetro realativo al efecto de la variable explicativa 
<span class="math align-center">$\mathbf{X}$</span>. En este caso 
<span class="math align-center">$\mathbf{X}$</span> es una variable de tipo factor que, en general, tiene 
<span class="math align-center">$f=\{1,...,F\}$</span> niveles, tal que 
<span class="math align-center">$(\forall i) (\exists! f) : \left\lbrace x_{if}=1 \wedge x_{i,-f}=\mathbf{0}\right\rbrace$</span>. Por tanto, para cada observación sólo uno de estos niveles tiene asociado un valor . El código que podríamos utilizar para simular este modelo es el presentado en el siguiente bloque de código.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">x</span> <span class="o">&lt;-</span> <span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="m">1E2</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="m">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">beta_0</span> <span class="o">&lt;-</span> <span class="m">-2</span>
</span></span><span class="line"><span class="cl"><span class="n">beta_1</span> <span class="o">&lt;-</span> <span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">lin_pred</span> <span class="o">&lt;-</span> <span class="n">beta_0</span> <span class="o">+</span> <span class="n">beta_1</span><span class="o">*</span><span class="n">x</span>
</span></span><span class="line"><span class="cl"><span class="n">y</span> <span class="o">&lt;-</span> <span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="m">1E2</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">lin_pred</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="m">3</span><span class="p">)</span>
</span></span></code></pre></div><p>Antes de organizar la información de los datos podemos especificar la fórmula del modelo,</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">formula_inla</span> <span class="o">&lt;-</span> <span class="n">y</span> <span class="o">~</span> <span class="m">-1</span> <span class="o">+</span> <span class="n">beta_0</span> <span class="o">+</span> <span class="n">beta_1</span>
</span></span></code></pre></div><h2 id="3-modelo-gaussiano-con-efectos-aleatorios">3. Modelo Gaussiano con efectos aleatorios</h2>
<h3 id="31-efectos-aleatorios-no-estructurados-iid">3.1 Efectos aleatorios no-estructurados (<em>iid</em>)</h3>
<h3 id="32-efectos-aleatorios-estructurados-en-una-dimensión-rw-ar-y-spde">3.2 Efectos aleatorios estructurados en una dimensión (<em>rw</em>, <em>ar</em> y <em>spde</em>)</h3>
<h3 id="33-efectos-aleatorios-estructurados-en-dos-dimensiones-besag-y-spde">3.3 Efectos aleatorios estructurados en dos dimensiones (<em>besag</em> y <em>spde</em>)</h3>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
<h1 id="stacks">Stacks</h1>


<div class="box notices cstyle info">
    <div class="box-label"><i class="fa-fw fas fa-info"></i> Información de versiones</div>
    <div class="box-content">
<p>En este rótulo inicial exponemos una lista con las versiones de los programas, sistema operativo y librearías con las que se ha ejecutado el código de la presente sección, lo cual se extrae principalmente mediante la función <code>sessionInfo()</code>.</p>
<ul>
<li>SO (version): Windows 11 Home (22H2).</li>
<li>R: 4.2.3 (2023-03-15 ucrt).</li>
<li>RStudio: 2023.06.2 (Build 561).</li>
<li>Libraries:
<ul>
<li>INLA: INLA_23.04.24</li>
</ul>
</li>
</ul>
    </div>
</div>
<p>Los <code>stack</code> son unas funciones implementadas en el paquete <strong>R-INLA</strong> que permite organizar la información necesaria de una fórma verátil y cómoda para posteriormente ser integrada en la llamada a la función de ajuste <code>inla(...)</code>. La función empleada para ello es <code>inla.stack(...)</code>, la cual produce un objeto <code>inla.data.stack</code>.</p>
<h2 id="1-estructura-de-un-stack">1. Estructura de un <em>stack</em></h2>
<p>La función <code>inla.stack(...)</code> organiza la información de la variable respuesta (<em>data</em>), los efectos del modelo (<em>effects</em>) y la matriz de proyección (<em>A</em>), matriz 
<span class="math align-center">$\mathbf{A}$</span> que liga el campo latente 
<span class="math align-center">$\mathbf{\mathcal{X}}$</span> con el predictor lineal 
<span class="math align-center">$\boldsymbol\eta$</span>. Por tanto, se dispondrá de un argumento asociado a cada uno de estos tres elementos, que será definido a través de una lista, junto con otros argumentos como <code>tag</code> que permite nombrar dicho <em>stack</em> y así, posteriormente, extraer índices o información según la etiqueta del <em>stack</em>.</p>
<p>La estructura del código quedaría sintetizada en el siguiente bloque de código:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">inla.stack</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="kc">...</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">A</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="kc">...</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">effects</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="kc">...</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">tag</span> <span class="o">=</span> <span class="s">&#34;stack_label&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span></code></pre></div><p>La función <code>inla.stack(...)</code> permite agrupar (<em>stakear</em>) otros objetos que sean ellos mismos también objetos de la clase <code>inla.data.stack</code>. Esto se debe a que la propia función <code>inla.stack(...)</code> es una función que llama a otras dos, <code>inla.stack.sum(...)</code> e <code>inla.stack.join(...)</code>, según se los argumentos introducidos sean los anteriormente expuestos o sean objetos <code>inla.data.stack</code>. En el primer caso se llamaría a la función <code>inla.stack.sum(...)</code>, mientras que en el segundo se llamaría a la función <code>inla.stack.join(...)</code>.</p>
<p>Además, hay otros dos argumentos, ligados a la función <code>inla.stack.sum(...)</code> que pueden, ser de gran utilidad en determinados casos: <code>compress</code> y <code>remove.unused</code>. El primero eliminaría elementos duplicados en los efectos, y por tanto eliminaría las columnas asociadas a <em>A</em> relativas a dichos efectos, mientras que el segundo argumento eliminaría aquellos efectos que tienen valores nulos para toda la columna en <em>A</em> (eliminando también dichas columnas). Esto podremos observarlo en el pequeño ejemplo muy <em>naive</em> dedicado a un modelo espacial.</p>
<p>En definitiva, la función permite automatizar la organización de los datos, por la generación <code>NAs</code> donde es necesario en el <code>data.frame</code> de los efectos y la integración de las matrices de proyección de los efectos y de distintos <em>stacks</em> cuando son agregados. Además, permite que la estructura general del código sea más legible al poder escindir partes del modelo en distintos <em>stacks</em> y así facilitar la escritura y lectura de código al apoyarnos en estas funciones.</p>
<h2 id="2-ejemplos-de-uso-con-toy-models">2. Ejemplos de uso con <em>toy models</em></h2>
<p>En este apartado expondremos unos breves ejemplos del uso de los <em>stacks</em> con unos modelos muy sencillos. Estos modelos emplean datos simulados y pueden ser demasiado simples, particularmente el segundo es un ejemplo algo artificial pero el objeto es tratar de exponer ejemplos variados para formar <em>stacks</em>. Los ejemplos son:</p>
<ol>
<li>Un modelo con dos efectos fijos.</li>
<li>Un modelo con interceptor y un efecto aleatorio <em>iid</em>.</li>
<li>Un modelo con interceptor y un efecto aleatorio espacialmente estructurado.</li>
</ol>
<h3 id="21-modelo-lineal-sin-efectos-aleatorios">2.1 Modelo lineal sin efectos aleatorios</h3>
<p>En este ejemplo vamos a simular un modelo Gaussiano con un interceptor 
<span class="math align-center">$(\beta_0)$</span> y un efecto fijo asociado a una variable explicativa numérica continua 
<span class="math align-center">$(\beta_1, \mathbf{x}\in\mathbb{R})$</span>.</p>
<p>El código necesario para la simulación es el siguiente</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">x</span> <span class="o">&lt;-</span> <span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="m">1E2</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="m">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">beta_0</span> <span class="o">&lt;-</span> <span class="m">-2</span>
</span></span><span class="line"><span class="cl"><span class="n">beta_1</span> <span class="o">&lt;-</span> <span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="n">lin_pred</span> <span class="o">&lt;-</span> <span class="n">beta_0</span> <span class="o">+</span> <span class="n">beta_1</span><span class="o">*</span><span class="n">x</span>
</span></span><span class="line"><span class="cl"><span class="n">y</span> <span class="o">&lt;-</span> <span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="m">1E2</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">lin_pred</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="m">3</span><span class="p">)</span>
</span></span></code></pre></div><p>Dados estos datos, podemos organizar la información en un <em>stack</em> según cualquiera de las siguientes alternativas:</p>

<div class="tab-panel">
  <div class="tab-nav">
    <button
      data-tab-item="Alt. 1"
      data-tab-group="default"
      class="tab-nav-button direction-ltr active"
      onclick="switchTab('default','Alt. 1')"
      ><span>Alt. 1</span></button>
    <button
      data-tab-item="Alt. 2"
      data-tab-group="default"
      class="tab-nav-button direction-ltr "
      onclick="switchTab('default','Alt. 2')"
      ><span>Alt. 2</span></button>
    <button
      data-tab-item="Alt. 3"
      data-tab-group="default"
      class="tab-nav-button direction-ltr "
      onclick="switchTab('default','Alt. 3')"
      ><span>Alt. 3</span></button>
  </div>
  <div class="tab-content">
    <div data-tab-item="Alt. 1" data-tab-group="default" class="tab-item active">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">inf_stack</span> <span class="o">&lt;-</span> 
</span></span><span class="line"><span class="cl">    <span class="nf">inla.stack</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">A</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="m">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">effects</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nf">list</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">beta_0</span><span class="o">=</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="m">1E2</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">beta_1</span><span class="o">=</span><span class="n">x</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">        <span class="n">tag</span><span class="o">=</span><span class="s">&#34;inf_stack&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span></code></pre></div>
    </div>
    <div data-tab-item="Alt. 2" data-tab-group="default" class="tab-item ">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">inf_stack</span> <span class="o">&lt;-</span> 
</span></span><span class="line"><span class="cl">    <span class="nf">inla.stack</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">A</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">effects</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">beta_0</span><span class="o">=</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="m">1E2</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">beta_1</span><span class="o">=</span><span class="n">x</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">tag</span><span class="o">=</span><span class="s">&#34;inf_stack&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span></code></pre></div>
    </div>
    <div data-tab-item="Alt. 3" data-tab-group="default" class="tab-item ">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">inf_stack</span> <span class="o">&lt;-</span> 
</span></span><span class="line"><span class="cl">    <span class="nf">inla.stack</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">A</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="nf">Diagonal</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="m">1E2</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="m">1</span><span class="p">),</span> <span class="nf">Diagonal</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="m">1E2</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">        <span class="n">effects</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">beta_0</span><span class="o">=</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="m">1E2</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">beta_1</span><span class="o">=</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span><span class="m">1E2</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">        <span class="n">tag</span><span class="o">=</span><span class="s">&#34;inf_stack&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span></code></pre></div>
    </div>
  </div>
</div>
<p>Con independencia de cual de las alternativas escojamos para construir el <em>stack</em> podremos emplear el mismo código para llamar a la función <code>inla(...)</code> y ajustar el modelo.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">inla_model</span> <span class="o">&lt;-</span> 
</span></span><span class="line"><span class="cl">    <span class="nf">inla</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">formula</span><span class="o">=</span><span class="n">y</span><span class="o">~</span><span class="m">-1</span><span class="o">+</span><span class="n">beta_0</span><span class="o">+</span><span class="n">beta_1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">family</span><span class="o">=</span><span class="s">&#34;gaussian&#34;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nf">inla.stack.data</span><span class="p">(</span><span class="n">inf_stack</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">control.predictor</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">A</span><span class="o">=</span><span class="nf">inla.stack.A</span><span class="p">(</span><span class="n">inf_stack</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span></code></pre></div><p>En la función <code>inla(...)</code> el argumento <code>data</code> es relativo a los datos de los modelos, debiendo hacer coincidir los nombres de los elementos entre la fórmula y los almacenados en el <em>stack</em>, los datos se extraen (como una lista) mediante la función <code>inla.stack.data</code>. Por otro lado, <code>control.predictor</code> es un argumento que nos permite definir una lista de argumentos relativos a opciones de configuración del predictor, particulamente hacemos uso del argumento <code>A</code>, que define la matriz de proyección y que podemos extraer del <em>stack</em> mediante la función <code>inla.stack.A</code>.</p>
<h3 id="22-modelo-lineal-con-efecto-aleatorio-iid">2.2 Modelo lineal con efecto aleatorio <em>iid</em></h3>
<p>En este caso simularemos un modelo con un interceptor y con un efecto aleatorio <em>iid</em>. Para ello nos valemos del siguiente código:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">beta_0</span> <span class="o">&lt;-</span> <span class="m">-2</span>
</span></span><span class="line"><span class="cl"><span class="n">w</span> <span class="o">&lt;-</span> <span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="m">1E2</span><span class="o">/</span><span class="m">2</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="m">0</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="m">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">lin_pred</span> <span class="o">&lt;-</span> <span class="n">beta_0</span> <span class="o">+</span> <span class="nf">c</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="nf">rep</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="n">times</span><span class="o">=</span><span class="m">50</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">y</span> <span class="o">&lt;-</span> <span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="m">1E2</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">lin_pred</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="m">0.1</span><span class="p">)</span>
</span></span></code></pre></div><p>En este caso estaríamos definiendo el predictor lineal como 
<span class="math align-center">$\boldsymbol\eta\equiv \left\lbrace \eta_{1:50}=\beta_0 + w_{1:50},\; \eta_{51:100}=\beta_0 \right\rbrace $</span>, tal que 
<span class="math align-center">$ \mathbf{w} \sim N(0, \tau=0.04)$</span>. La definición del <em>stack</em> ahora será un poco distinta, dado que debemos definir el interceptor para todo el predictor lineal y separar los dos efectos <em>iid</em> según la posición asociada al predictor. Algunas alternativas posibles de escribir correctamente los datos en un <em>stack</em> son las siguientes:</p>

<div class="tab-panel">
  <div class="tab-nav">
    <button
      data-tab-item="Alt. 1"
      data-tab-group="default"
      class="tab-nav-button direction-ltr active"
      onclick="switchTab('default','Alt. 1')"
      ><span>Alt. 1</span></button>
    <button
      data-tab-item="Alt. 2"
      data-tab-group="default"
      class="tab-nav-button direction-ltr "
      onclick="switchTab('default','Alt. 2')"
      ><span>Alt. 2</span></button>
  </div>
  <div class="tab-content">
    <div data-tab-item="Alt. 1" data-tab-group="default" class="tab-item active">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">inf_stack</span> <span class="o">&lt;-</span> 
</span></span><span class="line"><span class="cl">  <span class="nf">inla.stack</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">A</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="m">1</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">effects</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nf">list</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">beta_0</span><span class="o">=</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="n">times</span><span class="o">=</span><span class="m">100</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">w</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">50</span><span class="p">,</span><span class="nf">rep</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span><span class="n">times</span><span class="o">=</span><span class="m">50</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">)),</span>
</span></span><span class="line"><span class="cl">    <span class="n">tag</span><span class="o">=</span><span class="s">&#34;inf_stack&#34;</span><span class="p">)</span>
</span></span></code></pre></div>
    </div>
    <div data-tab-item="Alt. 2" data-tab-group="default" class="tab-item ">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">inf_stack</span> <span class="o">&lt;-</span> 
</span></span><span class="line"><span class="cl">  <span class="nf">inla.stack</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">A</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="m">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nf">Diagonal</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="m">100</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="n">times</span><span class="o">=</span><span class="m">50</span><span class="p">),</span><span class="nf">rep</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="n">times</span><span class="o">=</span><span class="m">50</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">effects</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">beta_0</span><span class="o">=</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="n">times</span><span class="o">=</span><span class="m">100</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="n">w</span><span class="o">=</span><span class="m">1</span><span class="o">:</span><span class="m">100</span>
</span></span><span class="line"><span class="cl">    <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">tag</span><span class="o">=</span><span class="s">&#34;inf_stack&#34;</span><span class="p">)</span>
</span></span></code></pre></div>
    </div>
  </div>
</div>
<p>Finalmente, la llamada a la función de ajuste es idéntica al anterior caso, con la excepción de que el argumento de la fórmula debemos cambiarlo para el nuevo modelo.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">inla_model</span> <span class="o">&lt;-</span> 
</span></span><span class="line"><span class="cl">  <span class="nf">inla</span><span class="p">(</span> 
</span></span><span class="line"><span class="cl">    <span class="n">formula</span><span class="o">=</span><span class="n">y</span><span class="o">~</span><span class="m">-1</span> <span class="o">+</span> <span class="n">beta_0</span> <span class="o">+</span> <span class="nf">f</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s">&#34;iid&#34;</span><span class="p">,</span> <span class="n">constr</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">family</span><span class="o">=</span><span class="s">&#34;gaussian&#34;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nf">inla.stack.data</span><span class="p">(</span><span class="n">inf_stack</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">control.predictor</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">A</span><span class="o">=</span><span class="nf">inla.stack.A</span><span class="p">(</span><span class="n">inf_stack</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span></code></pre></div><h3 id="23-modelo-lineal-con-efectos-aleatorios-espacialmente-estructurados">2.3 Modelo lineal con efectos aleatorios espacialmente estructurados</h3>
<p>En este último ejemplo simularemos datos con estructura espacial, en el que aprovecharemos para mostrar las diferencias de dejar algunos argumentos de forma predeterminada en la función <code>inla.stack(...)</code>.</p>
<p>La simulación de datos con dependencia espacial podemos hacerlo mediante el siguiente código, en el que se configura una malla, y los objetos necesarios del SPDE para simular un campo Gaussiano con función de covarianzas tipo Matèrn.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">mesh</span> <span class="o">&lt;-</span> <span class="nf">inla.mesh.2d</span><span class="p">(</span><span class="n">loc.domain</span> <span class="o">=</span> <span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">                                         <span class="n">ncol</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">byrow</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">                     <span class="n">max.edge</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">0.05</span><span class="p">,</span><span class="m">0.1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">spde</span> <span class="o">&lt;-</span> <span class="nf">inla.spde2.pcmatern</span><span class="p">(</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                            <span class="n">alpha</span> <span class="o">=</span> <span class="m">2</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                            <span class="n">prior.range</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">0.2</span><span class="p">,</span><span class="m">0.5</span><span class="p">),</span> 
</span></span><span class="line"><span class="cl">                            <span class="n">prior.sigma</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Q</span> <span class="o">&lt;-</span> <span class="nf">inla.spde2.precision</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">spde</span><span class="o">=</span><span class="n">spde</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">theta</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="nf">log</span><span class="p">(</span><span class="m">0.2</span><span class="p">),</span><span class="nf">log</span><span class="p">(</span><span class="m">1</span><span class="p">))</span> <span class="c1"># log(range), log(stdev.)</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">u</span> <span class="o">&lt;-</span> <span class="nf">inla.qsample</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">Q</span> <span class="o">=</span> <span class="n">Q</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sample.locations</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="nf">runif</span><span class="p">(</span><span class="m">5E2</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">A_u</span> <span class="o">&lt;-</span> <span class="nf">inla.spde.make.A</span><span class="p">(</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">sample.locations</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">beta_0</span> <span class="o">&lt;-</span> <span class="m">-2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">lin_pred</span> <span class="o">&lt;-</span> <span class="n">beta_0</span> <span class="o">+</span> <span class="nf">as.vector</span><span class="p">(</span><span class="n">A_u</span> <span class="o">%*%</span> <span class="n">u</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">y</span> <span class="o">&lt;-</span> <span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="nf">length</span><span class="p">(</span><span class="n">lin_pred</span><span class="p">),</span> <span class="n">mean</span> <span class="o">=</span> <span class="n">lin_pred</span><span class="p">,</span> <span class="n">sd</span> <span class="o">=</span> <span class="m">0.25</span><span class="p">)</span>
</span></span></code></pre></div><p>Las localizaciones de simulación son <code>sample.locations</code>, tal que el efecto espacial se simula en los nodos de la malla a dichas localizaciones a través de la matriz de proyección <code>A_u</code>, matriz que también será integrada en el <em>stack</em> para la matriz de proyección del efecto espacial.</p>
<p>El <em>stack</em> para el modelo espacial podemos contruirlo según el siguiente código:</p>

<div class="tab-panel">
  <div class="tab-nav">
    <button
      data-tab-item="Alt. 1"
      data-tab-group="default"
      class="tab-nav-button direction-ltr active"
      onclick="switchTab('default','Alt. 1')"
      ><span>Alt. 1</span></button>
    <button
      data-tab-item="Alt. 2"
      data-tab-group="default"
      class="tab-nav-button direction-ltr "
      onclick="switchTab('default','Alt. 2')"
      ><span>Alt. 2</span></button>
    <button
      data-tab-item="Alt. 3"
      data-tab-group="default"
      class="tab-nav-button direction-ltr "
      onclick="switchTab('default','Alt. 3')"
      ><span>Alt. 3</span></button>
    <button
      data-tab-item="Alt. 4"
      data-tab-group="default"
      class="tab-nav-button direction-ltr "
      onclick="switchTab('default','Alt. 4')"
      ><span>Alt. 4</span></button>
  </div>
  <div class="tab-content">
    <div data-tab-item="Alt. 1" data-tab-group="default" class="tab-item active">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">inf_stack</span> <span class="o">&lt;-</span> 
</span></span><span class="line"><span class="cl">  <span class="nf">inla.stack</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">A</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="n">A_u</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">effects</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nf">list</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">beta_0</span><span class="o">=</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="n">times</span><span class="o">=</span><span class="nf">length</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nf">list</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">spatial</span><span class="o">=</span><span class="m">1</span><span class="o">:</span><span class="n">spde</span><span class="o">$</span><span class="n">n.spde</span>
</span></span><span class="line"><span class="cl">      <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">tag</span><span class="o">=</span><span class="s">&#34;inf_stack&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span></code></pre></div>
    </div>
    <div data-tab-item="Alt. 2" data-tab-group="default" class="tab-item ">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">inf_stack</span> <span class="o">&lt;-</span> 
</span></span><span class="line"><span class="cl">  <span class="nf">inla.stack</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">A</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="n">A_u</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">effects</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">beta_0</span><span class="o">=</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="n">times</span><span class="o">=</span><span class="nf">length</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">        <span class="n">spatial</span><span class="o">=</span><span class="m">1</span><span class="o">:</span><span class="n">spde</span><span class="o">$</span><span class="n">n.spde</span>
</span></span><span class="line"><span class="cl">        <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">tag</span><span class="o">=</span><span class="s">&#34;inf_stack&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span></code></pre></div>
    </div>
    <div data-tab-item="Alt. 3" data-tab-group="default" class="tab-item ">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">inf_stack</span> <span class="o">&lt;-</span> 
</span></span><span class="line"><span class="cl">  <span class="nf">inla.stack</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">A</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="n">A_u</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">effects</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nf">list</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">beta_0</span><span class="o">=</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="n">times</span><span class="o">=</span><span class="nf">length</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nf">list</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">spatial</span><span class="o">=</span><span class="m">1</span><span class="o">:</span><span class="n">spde</span><span class="o">$</span><span class="n">n.spde</span>
</span></span><span class="line"><span class="cl">      <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">tag</span><span class="o">=</span><span class="s">&#34;inf_stack&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">compress</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">remove.unused</span> <span class="o">=</span> <span class="kc">FALSE</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span></code></pre></div>
    </div>
    <div data-tab-item="Alt. 4" data-tab-group="default" class="tab-item ">
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">inf_stack</span> <span class="o">&lt;-</span> 
</span></span><span class="line"><span class="cl">  <span class="nf">inla.stack</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">A</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="n">A_u</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">effects</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">beta_0</span><span class="o">=</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="n">times</span><span class="o">=</span><span class="nf">length</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">        <span class="n">spatial</span><span class="o">=</span><span class="m">1</span><span class="o">:</span><span class="n">spde</span><span class="o">$</span><span class="n">n.spde</span>
</span></span><span class="line"><span class="cl">        <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">tag</span><span class="o">=</span><span class="s">&#34;inf_stack&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">compress</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">remove.unused</span> <span class="o">=</span> <span class="kc">FALSE</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span></code></pre></div>
    </div>
  </div>
</div>
<p>En las alternativas 1 y 2 simplemente tenemos dos formas distintas de formar el <em>stack</em>, mientras que las alternativas 3 y 4 son respectivamente la 1 y 2, pero eliminando la compresión o simplificación de la matriz de proyección y de los efectos. Si comparamos la matriz de proyección almacenada en el objeto <code>inf_stack</code>, entre las alternativas 1-2 y 3-4 podremos observar que las dimensiones para las dos primeras es inferior a las de las dos últimas, dado que se eliminarían los índices del efecto espacial asociados a las columnas de la matriz de proyección cuyas columnas sólo contengan valores nulos (debido al argumento predeterminado <code>remove.unused = TRUE</code>), junto con la eliminación de estas columnas de valores cero.</p>
<p>Finalmente para ajustar el modelo el código necesario es básicamente el ya empleado, pero cambiando la expresión de la fórmula para el modelo.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">inla_model</span> <span class="o">&lt;-</span> 
</span></span><span class="line"><span class="cl">  <span class="nf">inla</span><span class="p">(</span> 
</span></span><span class="line"><span class="cl">    <span class="n">formula</span><span class="o">=</span><span class="n">y</span><span class="o">~</span><span class="m">-1</span> <span class="o">+</span> <span class="n">beta_0</span> <span class="o">+</span> <span class="nf">f</span><span class="p">(</span><span class="n">spatial</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">spde</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">family</span><span class="o">=</span><span class="s">&#34;gaussian&#34;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nf">inla.stack.data</span><span class="p">(</span><span class="n">inf_stack</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">control.predictor</span><span class="o">=</span><span class="nf">list</span><span class="p">(</span><span class="n">A</span><span class="o">=</span><span class="nf">inla.stack.A</span><span class="p">(</span><span class="n">inf_stack</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span></code></pre></div><h2 id="3-funciones-extras-para-los-stacks">3. Funciones extras para los <em>stacks</em></h2>
<p>Otras funciones que podemos utilizar sobre los <em>stacks</em> son <code>inla.stack.index(...)</code>, <code>inla.stack.LHS(...)</code> y <code>inla.stack.RHS(...)</code>.</p>
<p>La primera función requiere de dos argumentos, el <code>stack</code> y la etiqueta <code>tag</code> para la extracción de índices de los datos y los efectos. Esto es, si consideramos algunos de los ejemplos previos podríamos emplear esta función como</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">index</span> <span class="o">&lt;-</span> <span class="nf">inla.stack.index</span><span class="p">(</span><span class="n">stack</span><span class="o">=</span><span class="n">inf_stack</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s">&#34;inf_stack&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>El cual devuelve una lista con dos elementos, <code>data</code> y <code>effects</code>, con los correspondientes índices de los datos y los efectos que podemos emplear para extraerlos de la salida del ajuste del modelo para el predictor lineal.</p>
<p>Las otras dos funciones permite extraer los valores de los elementos del lado izquierdo de la fórmula (<code>inla.stack.LHS(...)</code>) y los del lado derecho (<code>inla.stack.RHS(...)</code>). En ambos casos sólo se necesita especificar el <em>stack</em> sobre el que se aplicará la función.</p>

            <footer class="footline">
            </footer>
          </article>

          <article class="default">
<h1 id="conformaci%C3%B3n-de-mallas">Conformación de Mallas</h1>


            <footer class="footline">
            </footer>
          </article>

          <article class="default">
<h1 id="caracter%C3%ADsticas-avanzadas">Características Avanzadas</h1>


            <footer class="footline">
            </footer>
          </article>

          </section>        </div>
      </main>
    </div>
    <script src="../../../js/clipboard.min.js" defer></script>
    <script src="../../../js/perfect-scrollbar.min.js" defer></script>
    <script src="../../../js/featherlight.min.js" defer></script>
    <script>
      function useMathJax( config ){
        if( !Object.assign ){
          
          return;
        }
        window.MathJax = Object.assign( window.MathJax || {}, {
          loader: {
            load: ['[tex]/mhchem']
          },
          startup: {
            elements: [
              '.math'
            ]
          },
          tex: {
            inlineMath: [
              ['$', '$'], 
              ['\\(', '\\)']
            ]
          },
          options: {
            enableMenu: false 
          }
        }, config );
      }
      useMathJax( JSON.parse("{}") );
    </script>
    <script id="MathJax-script" async src="../../../js/mathjax/tex-mml-chtml.js"></script>
    <script src="../../../js/jquery.svg.pan.zoom.js" defer></script>
    <script src="../../../js/mermaid.min.js" defer></script>
    <script>
      window.themeUseMermaid = JSON.parse("{ \"securityLevel\": \"loose\" }");
    </script>
    <script src="../../../js/theme.js" defer></script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-105947713-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
